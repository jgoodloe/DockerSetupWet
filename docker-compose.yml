version: '3.9'

# Define persistent volumes for key services
volumes:
  npm_data:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/data/nginx_proxy_manager
      o: bind
  npm_letsencrypt:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/data/letsencrypt
      o: bind
  mariadb_data:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/data/mariadb
      o: bind
  appsec_config:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/data/appsec_agent/config
      o: bind
  appsec_data:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/data/appsec_agent/data
      o: bind
  appsec_logs:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/data/appsec_agent/logs
      o: bind
  prometheus_data:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/data/prometheus
      o: bind
  loki_data:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/data/loki
      o: bind
  grafana_data:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/data/grafana

networks:
  # Internal network for all core services
  core_services:
    driver: bridge
  # Dedicated network for monitoring components to isolate traffic
  monitoring:
    driver: bridge

services:
  # --- Open-AppSec WAF and NGINX Proxy Manager (NPM) ---
  
  # 1. NGINX Proxy Manager with Open-AppSec WAF Attachment
  appsec-nginx-proxy-manager:
    image: ghcr.io/openappsec/open-appsec-npm:latest
    container_name: appsec-nginx-proxy-manager
    restart: unless-stopped
    # Expose necessary ports (80/443 for public traffic, 81 for NPM Admin UI)
    ports:
      - '80:80'
      - '443:443'
      - '81:81'
    environment:
      # NPM Configuration
      TZ: Europe/London
      DB_MYSQL_HOST: mariadb
      DB_MYSQL_PORT: 3306
      DB_MYSQL_USER: npm
      DB_MYSQL_PASSWORD: ${DB_MYSQL_PASSWORD}
      DB_MYSQL_NAME: npm
      # Open-AppSec configuration
      APPSEC_MANAGER_MODE: managed-saas # Explicitly set to SaaS managed mode
      APPSEC_AGENT_TOKEN: ${APPSEC_AGENT_TOKEN} # Token from .env
      APPSEC_USER_EMAIL: ${APPSEC_USER_EMAIL} # Email from .env
    volumes:
      - npm_data:/data
      - npm_letsencrypt:/etc/letsencrypt
    networks:
      - core_services
      
  # 2. MariaDB Database for NGINX Proxy Manager
  mariadb:
    image: mariadb:latest
    container_name: mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: npm
      MYSQL_USER: npm
      MYSQL_PASSWORD: ${DB_MYSQL_PASSWORD}
    volumes:
      - mariadb_data:/var/lib/mysql
    networks:
      - core_services

  # 3. Open-AppSec Agent (Required for WAF policy enforcement)
  appsec-agent:
    image: ghcr.io/openappsec/agent:latest
    container_name: appsec-agent
    ipc: host
    restart: unless-stopped
    privileged: true
    environment:
      APPSEC_AGENT_TOKEN: ${APPSEC_AGENT_TOKEN}
      APPSEC_USER_EMAIL: ${APPSEC_USER_EMAIL}
    volumes:
      - appsec_config:/etc/cp/conf:rw # Configuration files
      - appsec_data:/etc/cp/data:rw # Persistent data/learning
      - appsec_logs:/var/log/nano_agent:rw # Agent logs
    networks:
      - core_services
      
  # --- Monitoring Stack: Prometheus, Loki, Grafana, Exporters ---

  # 4. Prometheus Time Series Database
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - prometheus_data:/etc/prometheus
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.html=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle' # Allows config reload without restart
    networks:
      - monitoring

  # 5. Loki Log Aggregation System
  loki:
    image: grafana/loki:latest
    container_name: loki
    restart: unless-stopped
    ports:
      - "3100:3100" # Loki HTTP/Metrics port
    volumes:
      - loki_data:/etc/loki
      - loki_data:/loki
    command: -config.file=/etc/loki/config.yml
    networks:
      - monitoring

  # 6. Grafana Visualization Dashboard
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000" # Grafana Web UI
    environment:
      # Default user/pass is admin/admin. Change this immediately!
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      # Provisioning enables automatic datasource/dashboard loading
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
    volumes:
      - grafana_data:/var/lib/grafana
      - ${PWD}/data/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ${PWD}/data/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ${PWD}/data/grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
      - loki
    networks:
      - monitoring

  # 7. cAdvisor (Container Advisor) - Gathers container-level metrics
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    restart: unless-stopped
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    ports:
      - "8080:8080" # cAdvisor default port
    networks:
      - monitoring

  # 8. Node Exporter - Gathers host system metrics (CPU, Memory, Disk)
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - --path.procfs=/host/proc
      - --path.sysfs=/host/sys
      - --collector.filesystem.mount-points-exclude=^/(dev|proc|sys|var/lib/docker/.+|var/run/docker.sock)
    ports:
      - "9100:9100" # Node Exporter default port
    networks:
      - monitoring
